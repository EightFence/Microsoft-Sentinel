{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/ae4f67a6-0713-4a26-ae61-284e67b408c1')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ae4f67a6-0713-4a26-ae61-284e67b408c1')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "status": "Available",
        "customDetails": {
          "AttackRule": "rule_s",
          "AttackedEndpoint": "request_headers_referer_s",
          "Environment": "environment_s",
          "AttackResult": "result_s",
          "TargetHost": "host_hostname_s",
          "ApplicationName": "application_name_s"
        },
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "{{result_s}} {{rule_s}} from {{SourceIP}} ",
          "alertDescriptionFormat": "{{result_s}}  on {{request_headers_referer_s}}  endpoint of {{application_name_s}} "
        },
        "queryPeriod": "5m",
        "description": "'Detects successful exploitation of security vulnerabilities across all environments as identified by Contrast ADR. This rule captures confirmed exploited attacks that bypassed application security controls and require security team investigation.'\n",
        "severity": "High",
        "query": "ContrastADR_CL\n| where result_s =~ \"exploited\"\n",
        "queryFrequency": "5m",
        "tactics": [
          "InitialAccess",
          "Execution",
          "DefenseEvasion",
          "LateralMovement",
          "CommandAndControl"
        ],
        "triggerThreshold": 0,
        "name": "Contrast ADR - Exploited Attack Event",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "SourceIP"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "host_hostname_s"
              }
            ],
            "entityType": "Host"
          }
        ],
        "incidentConfiguration": {
          "groupingConfiguration": {
            "enabled": true,
            "groupByEntities": [
              "IP",
              "Host"
            ],
            "lookbackDuration": "PT1H",
            "reopenClosedIncident": false,
            "matchingMethod": "Selected"
          },
          "createIncident": true
        },
        "triggerOperator": "gt"
      }
    }
  ]
}
