{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/ae4f67a6-0713-4a26-ae61-284e67b408c1')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ae4f67a6-0713-4a26-ae61-284e67b408c1')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "triggerOperator": "gt",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "description": "'Detects successful exploitation of security vulnerabilities across all environments as identified by Contrast ADR. This rule captures confirmed exploited attacks that bypassed application security controls and require security team investigation.'\n",
        "customDetails": {
          "AttackRule": "rule_s",
          "ApplicationName": "application_name_s",
          "Environment": "environment_s",
          "TargetHost": "host_hostname_s",
          "AttackResult": "result_s",
          "AttackedEndpoint": "request_headers_referer_s"
        },
        "status": "Available",
        "queryPeriod": "5m",
        "name": "Contrast ADR - Exploited Attack Event",
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "{{result_s}} {{rule_s}} from {{SourceIP}} ",
          "alertDescriptionFormat": "{{result_s}}  on {{request_headers_referer_s}}  endpoint of {{application_name_s}} "
        },
        "severity": "High",
        "queryFrequency": "5m",
        "tactics": [
          "InitialAccess",
          "Execution",
          "DefenseEvasion",
          "LateralMovement",
          "CommandAndControl"
        ],
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "enabled": true,
            "groupByEntities": [
              "IP",
              "Host"
            ],
            "reopenClosedIncident": false,
            "lookbackDuration": "PT1H",
            "matchingMethod": "Selected"
          }
        },
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "SourceIP",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "columnName": "host_hostname_s",
                "identifier": "HostName"
              }
            ],
            "entityType": "Host"
          }
        ],
        "triggerThreshold": 0,
        "query": "ContrastADR_CL\n| where result_s =~ \"exploited\"\n"
      }
    }
  ]
}
