{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/ae4f67a6-0713-4a26-ae61-284e67b408c1')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ae4f67a6-0713-4a26-ae61-284e67b408c1')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "name": "Contrast ADR - Exploited Attack Event",
        "queryFrequency": "5m",
        "status": "Available",
        "triggerThreshold": 0,
        "severity": "High",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "groupByEntities": [
              "IP",
              "Host"
            ],
            "lookbackDuration": "PT1H",
            "reopenClosedIncident": false,
            "matchingMethod": "Selected",
            "enabled": true
          },
          "createIncident": true
        },
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "tactics": [
          "InitialAccess",
          "Execution",
          "DefenseEvasion",
          "LateralMovement",
          "CommandAndControl"
        ],
        "description": "'Detects successful exploitation of security vulnerabilities across all environments as identified by Contrast ADR. This rule captures confirmed exploited attacks that bypassed application security controls and require security team investigation.'\n",
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "SourceIP"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "host_hostname_s"
              }
            ],
            "entityType": "Host"
          }
        ],
        "customDetails": {
          "TargetHost": "host_hostname_s",
          "AttackedEndpoint": "request_headers_referer_s",
          "AttackRule": "rule_s",
          "AttackResult": "result_s",
          "Environment": "environment_s",
          "ApplicationName": "application_name_s"
        },
        "query": "ContrastADR_CL\n| where result_s =~ \"exploited\"\n",
        "queryPeriod": "5m",
        "alertDetailsOverride": {
          "alertDescriptionFormat": "{{result_s}}  on {{request_headers_referer_s}}  endpoint of {{application_name_s}} ",
          "alertDisplayNameFormat": "{{result_s}} {{rule_s}} from {{SourceIP}} "
        },
        "triggerOperator": "gt"
      }
    }
  ]
}
