{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/ae4f67a6-0713-4a26-ae61-284e67b408c1')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ae4f67a6-0713-4a26-ae61-284e67b408c1')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "description": "'Detects successful exploitation of security vulnerabilities across all environments as identified by Contrast ADR. This rule captures confirmed exploited attacks that bypassed application security controls and require security team investigation.'\n",
        "triggerThreshold": 0,
        "name": "Contrast ADR - Exploited Attack Event",
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "SourceIP",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "columnName": "host_hostname_s",
                "identifier": "HostName"
              }
            ],
            "entityType": "Host"
          }
        ],
        "query": "ContrastADR_CL\n| where result_s =~ \"exploited\"\n",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "enabled": true,
            "lookbackDuration": "PT1H",
            "groupByEntities": [
              "IP",
              "Host"
            ],
            "reopenClosedIncident": false,
            "matchingMethod": "Selected"
          },
          "createIncident": true
        },
        "queryPeriod": "5m",
        "tactics": [
          "InitialAccess",
          "Execution",
          "DefenseEvasion",
          "LateralMovement",
          "CommandAndControl"
        ],
        "customDetails": {
          "AttackRule": "rule_s",
          "Environment": "environment_s",
          "ApplicationName": "application_name_s",
          "TargetHost": "host_hostname_s",
          "AttackResult": "result_s",
          "AttackedEndpoint": "request_headers_referer_s"
        },
        "triggerOperator": "gt",
        "alertDetailsOverride": {
          "alertDescriptionFormat": "{{result_s}}  on {{request_headers_referer_s}}  endpoint of {{application_name_s}} ",
          "alertDisplayNameFormat": "{{result_s}} {{rule_s}} from {{SourceIP}} "
        },
        "queryFrequency": "5m",
        "severity": "High",
        "status": "Available",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        }
      }
    }
  ]
}
