{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/17cce4fc-9b4c-4eef-a4c7-083b44545e6e')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/17cce4fc-9b4c-4eef-a4c7-083b44545e6e')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "queryFrequency": "5m",
        "description": "\"Detects phishing campaigns targeting enterprise domains, as identified through CYFIRMA's Data Breach and Dark Web Monitoring. \nThese alerts may include malicious URLs used for credential harvesting, domain impersonation, or social engineering. \nImmediate triage and takedown actions are recommended.\"\n",
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "CYFIRMA - High Severity Alert:  Phishing Campaign Detection - {{AlertTitle}} ",
          "alertDescriptionFormat": "{{Description}} ",
          "alertDynamicProperties": [
            {
              "alertProperty": "ProductName",
              "value": "ProductName"
            },
            {
              "alertProperty": "ProviderName",
              "value": "ProviderName"
            }
          ]
        },
        "triggerOperator": "gt",
        "queryPeriod": "5m",
        "triggerThreshold": 0,
        "status": "Available",
        "customDetails": {
          "Impact": "Impact",
          "UID": "UID",
          "AssetType": "AssetType",
          "TimeGenerated": "TimeGenerated",
          "AlertUID": "AlertUID",
          "FirstSeen": "FirstSeen",
          "Source": "Source",
          "Recommendation": "Recommendation",
          "AssetValue": "AssetValue",
          "RiskScore": "RiskScore",
          "Description": "Description",
          "LastSeen": "LastSeen"
        },
        "query": "// High severity - Data Breach and Web Monitoring - Phishing Campaign Detection\nlet timeFrame = 5m;\nCyfirmaDBWMPhishingAlerts_CL\n| where severity == 'Critical' and TimeGenerated between (ago(timeFrame) .. now())\n| extend\n    Description=description,\n    FirstSeen=first_seen,\n    LastSeen=last_seen,\n    RiskScore=risk_score,\n    AlertUID=alert_uid,\n    UID=uid,\n    AssetType=asset_type,\n    AssetValue=signature,\n    Source=source,\n    Impact='',\n    Recommendation='',\n    ProviderName='CYFIRMA',\n    ProductName='DeCYFIR/DeTCT',\n    AlertTitle=Alert_title\n| project\n    TimeGenerated,\n    Description,\n    RiskScore,\n    FirstSeen,\n    LastSeen,\n    AlertUID,\n    UID,\n    AssetType,\n    AssetValue,\n    Source,\n    Impact,\n    Recommendation,\n    ProductName,\n    ProviderName,\n    AlertTitle\n",
        "tactics": [
          "InitialAccess",
          "Exfiltration"
        ],
        "severity": "High",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "name": "CYFIRMA - Data Breach and Web Monitoring - Phishing Campaign Detection Rule",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "matchingMethod": "AllEntities",
            "enabled": false,
            "reopenClosedIncident": false,
            "lookbackDuration": "5h"
          },
          "createIncident": true
        }
      }
    }
  ]
}
