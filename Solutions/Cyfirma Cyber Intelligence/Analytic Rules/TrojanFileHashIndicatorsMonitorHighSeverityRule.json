{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/4afd8960-8bee-4cac-bb5e-a4f200b1f9f3')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/4afd8960-8bee-4cac-bb5e-a4f200b1f9f3')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "alertDetailsOverride": {
          "alertDynamicProperties": [
            {
              "value": "ProductName",
              "alertProperty": "ProductName"
            },
            {
              "value": "ProviderName",
              "alertProperty": "ProviderName"
            }
          ],
          "alertDescriptionFormat": "{{Description}} - {{name}} ",
          "alertDisplayNameFormat": "High-Confidence Trojan File Hash Indicators with Monitor Action - {{name}} "
        },
        "suppressionDuration": "5m",
        "triggerOperator": "GreaterThan",
        "queryFrequency": "5m",
        "severity": "High",
        "description": "\"This KQL query extracts file hash indicators associated with Trojan activity from the CyfirmaIndicators_CL table. \nIt specifically targets indicators containing file hashes linked to Trojan behavior and retrieves MD5, SHA1, and SHA256 values. \nThe query also includes contextual threat intelligence such as threat actors, tags, sources, and geolocation information.\"\n",
        "triggerThreshold": 0,
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "matchingMethod": "AllEntities",
            "lookbackDuration": "PT5H",
            "reopenClosedIncident": false,
            "enabled": false
          }
        },
        "queryPeriod": "5m",
        "enabled": false,
        "suppressionEnabled": true,
        "name": "CYFIRMA - High severity Trojan File Hash Indicators with Monitor Action Rule",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "Algo_MD5",
                "identifier": "Algorithm"
              },
              {
                "columnName": "MD5",
                "identifier": "Value"
              }
            ],
            "entityType": "FileHash"
          },
          {
            "fieldMappings": [
              {
                "columnName": "Algo_SHA1",
                "identifier": "Algorithm"
              },
              {
                "columnName": "SHA1",
                "identifier": "Value"
              }
            ],
            "entityType": "FileHash"
          },
          {
            "fieldMappings": [
              {
                "columnName": "Algo_SHA256",
                "identifier": "Algorithm"
              },
              {
                "columnName": "SHA256",
                "identifier": "Value"
              }
            ],
            "entityType": "FileHash"
          }
        ],
        "query": "//Trojan File Hash Indicators with Monitor Action\nlet timeFrame = 5m;\nCyfirmaIndicators_CL \n| where ConfidenceScore >= 80\n    and TimeGenerated between (ago(timeFrame) .. now())\n    and pattern contains 'file:hashes' and RecommendedActions has 'Monitor' and (Roles contains 'Trojan')\n| extend MD5 = extract(@\"file:hashes\\.md5\\s*=\\s*'([a-fA-F0-9]{32})'\", 1, pattern)\n| extend SHA1 = extract(@\"file:hashes\\.'SHA-1'\\s*=\\s*'([a-fA-F0-9]{40})'\", 1, pattern)\n| extend SHA256 = extract(@\"file:hashes\\.'SHA-256'\\s*=\\s*'([a-fA-F0-9]{64})'\", 1, pattern)\n| extend\n    Algo_MD5='md5',\n    Algo_SHA1= 'SHA1',\n    Algo_SHA256='SHA256',\n    ProviderName = 'CYFIRMA',\n    ProductName = 'DeCYFIR/DeTCT'\n| project  \n    MD5,\n    Algo_MD5,\n    SHA1,\n    Algo_SHA1,\n    SHA256,\n    Algo_SHA256,\n    ThreatActors,\n    Sources,\n    RecommendedActions,\n    Roles,\n    Country,\n    name,\n    Description,\n    ConfidenceScore,\n    SecurityVendors,\n    IndicatorID,\n    created,\n    modified,\n    valid_from,\n    Tags,\n    ThreatType,\n    TimeGenerated,\n    ProductName,\n    ProviderName\n",
        "customDetails": {
          "Description": "Description",
          "Sources": "Sources",
          "Roles": "Roles",
          "modified": "modified",
          "TimeGenerated": "TimeGenerated",
          "Country": "Country",
          "ValidFrom": "valid_from",
          "RecommendedActions": "RecommendedActions",
          "ConfidenceScore": "ConfidenceScore",
          "SecurityVendors": "SecurityVendors",
          "created": "created",
          "IndicatorID": "IndicatorID",
          "ThreatActors": "ThreatActors",
          "ThreatType": "ThreatType",
          "Tags": "Tags"
        },
        "tactics": [
          "InitialAccess",
          "Execution",
          "Persistence",
          "DefenseEvasion",
          "CommandAndControl",
          "CredentialAccess"
        ]
      }
    }
  ]
}
