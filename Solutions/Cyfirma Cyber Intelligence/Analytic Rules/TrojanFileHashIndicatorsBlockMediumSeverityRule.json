{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/25686f44-5f5f-4388-95e2-eea244481438')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/25686f44-5f5f-4388-95e2-eea244481438')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Value",
                "columnName": "MD5"
              },
              {
                "identifier": "Algorithm",
                "columnName": "Algo_MD5"
              }
            ],
            "entityType": "FileHash"
          },
          {
            "fieldMappings": [
              {
                "identifier": "Value",
                "columnName": "SHA1"
              },
              {
                "identifier": "Algorithm",
                "columnName": "Algo_SHA1"
              }
            ],
            "entityType": "FileHash"
          },
          {
            "fieldMappings": [
              {
                "identifier": "Value",
                "columnName": "SHA256"
              },
              {
                "identifier": "Algorithm",
                "columnName": "Algo_SHA256"
              }
            ],
            "entityType": "FileHash"
          }
        ],
        "triggerThreshold": 0,
        "severity": "Medium",
        "tactics": [
          "InitialAccess",
          "Execution",
          "Persistence",
          "DefenseEvasion",
          "CommandAndControl",
          "CredentialAccess"
        ],
        "enabled": false,
        "customDetails": {
          "TimeGenerated": "TimeGenerated",
          "RecommendedActions": "RecommendedActions",
          "ConfidenceScore": "ConfidenceScore",
          "Description": "Description",
          "ThreatType": "ThreatType",
          "Country": "Country",
          "created": "created",
          "IndicatorID": "IndicatorID",
          "ValidFrom": "valid_from",
          "SecurityVendors": "SecurityVendors",
          "Roles": "Roles",
          "Sources": "Sources",
          "ThreatActors": "ThreatActors",
          "Tags": "Tags",
          "modified": "modified"
        },
        "triggerOperator": "GreaterThan",
        "description": "\"This KQL query extracts file hash indicators associated with Trojan activity from the CyfirmaIndicators_CL table. \nIt specifically targets indicators containing file hashes linked to Trojan behavior and retrieves MD5, SHA1, and SHA256 values. \nThe query also includes contextual threat intelligence such as threat actors, tags, sources, and geolocation information.\"\n",
        "alertDetailsOverride": {
          "alertDescriptionFormat": "{{Description}} - {{name}} ",
          "alertDynamicProperties": [
            {
              "alertProperty": "ProductName",
              "value": "ProductName"
            },
            {
              "alertProperty": "ProviderName",
              "value": "ProviderName"
            }
          ],
          "alertDisplayNameFormat": "High-Confidence Trojan File Hash Indicators with Block Action Rule - {{name}} "
        },
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "matchingMethod": "AllEntities",
            "enabled": false,
            "lookbackDuration": "5m",
            "reopenClosedIncident": false
          }
        },
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "query": "//Trojan File Hash Indicators with Block Action\nlet timeFrame = 5m;\nCyfirmaIndicators_CL \n| where (ConfidenceScore < 80 and ConfidenceScore >= 50)\n    and TimeGenerated between (ago(timeFrame) .. now())\n    and pattern contains 'file:hashes' and RecommendedActions has 'Block' and (Roles has 'Trojan')\n| extend MD5 = extract(@\"file:hashes\\.md5\\s*=\\s*'([a-fA-F0-9]{32})'\", 1, pattern)\n| extend SHA1 = extract(@\"file:hashes\\.'SHA-1'\\s*=\\s*'([a-fA-F0-9]{40})'\", 1, pattern)\n| extend SHA256 = extract(@\"file:hashes\\.'SHA-256'\\s*=\\s*'([a-fA-F0-9]{64})'\", 1, pattern)\n| extend\n    Algo_MD5='MD5',\n    Algo_SHA1= 'SHA1',\n    Algo_SHA256='SHA256',\n    ProviderName = 'CYFIRMA',\n    ProductName = 'DeCYFIR/DeTCT'\n| project  \n    MD5,\n    Algo_MD5,\n    SHA1,\n    Algo_SHA1,\n    SHA256,\n    Algo_SHA256,\n    ThreatActors,\n    Sources,\n    RecommendedActions,\n    Roles,\n    Country,\n    name,\n    Description,\n    ConfidenceScore,\n    SecurityVendors,\n    IndicatorID,\n    created,\n    modified,\n    valid_from,\n    Tags,\n    ThreatType,\n    TimeGenerated,\n    ProductName,\n    ProviderName\n",
        "suppressionDuration": "5m",
        "queryFrequency": "5m",
        "suppressionEnabled": true,
        "queryPeriod": "5m",
        "name": "CYFIRMA - Medium severity Trojan File Hash Indicators with Block Action Rule"
      }
    }
  ]
}
