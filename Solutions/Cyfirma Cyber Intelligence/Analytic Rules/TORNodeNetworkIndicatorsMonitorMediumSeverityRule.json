{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/e41b7640-9ba6-42d6-a4c9-1ab6932a0b14')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/e41b7640-9ba6-42d6-a4c9-1ab6932a0b14')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "suppressionEnabled": true,
        "alertDetailsOverride": {
          "alertDescriptionFormat": "{{Description}} - {{name}} ",
          "alertDisplayNameFormat": "High-Confidence TOR Node Network Indicators - Monitor Recommended - {{name}} ",
          "alertDynamicProperties": [
            {
              "value": "ProductName",
              "alertProperty": "ProductName"
            },
            {
              "value": "ProviderName",
              "alertProperty": "ProviderName"
            }
          ]
        },
        "description": "\"This KQL query identifies network-based indicators from CYFIRMA intelligence that are associated with the role 'TOR'. \nThese indicators may include IP addresses, domains, and URLs related to Tor network activity. \nThreat actors often use Tor for anonymous communication, command and control, data exfiltration, and evasion of network defenses.\"\n",
        "suppressionDuration": "5m",
        "queryPeriod": "5m",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "tactics": [
          "CommandAndControl",
          "Exfiltration",
          "InitialAccess",
          "Persistence",
          "Reconnaissance"
        ],
        "severity": "Medium",
        "customDetails": {
          "Roles": "Roles",
          "ConfidenceScore": "ConfidenceScore",
          "ValidFrom": "valid_from",
          "SecurityVendors": "SecurityVendors",
          "Modified": "modified",
          "Created": "created",
          "Tags": "Tags",
          "Country": "Country",
          "Sources": "Sources",
          "RecommendedActions": "RecommendedActions",
          "ThreatActors": "ThreatActors",
          "IndicatorID": "IndicatorID",
          "IPAbuse": "IPAbuse",
          "TimeGenerated": "TimeGenerated",
          "Description": "Description",
          "ThreatType": "ThreatType"
        },
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IPv4"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IPv6"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "identifier": "DomainName",
                "columnName": "Domain"
              }
            ],
            "entityType": "DNS"
          },
          {
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "URL"
              }
            ],
            "entityType": "URL"
          }
        ],
        "triggerThreshold": 0,
        "queryFrequency": "5m",
        "query": "//TOR Node Network Indicators - Monitor Recommended \nlet timeFrame= 5m;\nCyfirmaIndicators_CL \n| where (ConfidenceScore < 80 and ConfidenceScore >= 50)\n    and TimeGenerated between (ago(timeFrame) .. now())\n    and pattern !contains 'file:hashes' and RecommendedActions has 'Monitor' and Roles has 'TOR'\n| extend IPv4 = extract(@\"ipv4-addr:value\\s*=\\s*'([^']+)'\", 1, pattern)\n| extend IPv6 = extract(@\"ipv6-addr:value\\s*=\\s*'([^']+)'\", 1, pattern)\n| extend URL = extract(@\"url:value\\s*=\\s*'([^']+)'\", 1, pattern)\n| extend Domain = extract(@\"domain-name:value\\s*=\\s*'([^']+)'\", 1, pattern)\n| extend parsed = parse_json(extensions)\n| extend extensionKeys = bag_keys(parsed)\n| mv-expand extensionKeys\n| extend extensionKeyStr = tostring(extensionKeys)\n| extend ext = parsed[extensionKeyStr]\n| extend props = ext.properties\n| extend \n    extension_id = extensionKeyStr,\n    ASN_Owner = props.asn_owner,\n    ASN = props.asn,\n    ProviderName = 'CYFIRMA',\n    ProductName = 'DeCYFIR/DeTCT'\n| project\n    IPv4,\n    IPv6,\n    URL,\n    Domain,\n    ThreatActors,\n    RecommendedActions,\n    Sources,\n    Roles,\n    Country,\n    IPAbuse,\n    name,\n    Description,\n    ConfidenceScore,\n    IndicatorID,\n    created,\n    modified,\n    valid_from,\n    Tags,\n    ThreatType,\n    TimeGenerated,\n    SecurityVendors,\n    ProductName,\n    ProviderName\n",
        "enabled": false,
        "triggerOperator": "GreaterThan",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "lookbackDuration": "PT5H",
            "reopenClosedIncident": false,
            "enabled": false,
            "matchingMethod": "AllEntities"
          },
          "createIncident": true
        },
        "name": "CYFIRMA - Medium severity TOR Node Network Indicators - Monitor Recommended Rule"
      }
    }
  ]
}
