{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/fa53ac37-a646-4106-91b6-ce478a1b5323')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/fa53ac37-a646-4106-91b6-ce478a1b5323')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "enabled": false,
        "queryFrequency": "5m",
        "description": "\"This KQL query identifies network-based indicators from CYFIRMA intelligence that are associated with the role 'TOR'. \nThese indicators may include IP addresses, domains, and URLs related to Tor network activity. \nThreat actors often use Tor for anonymous communication, command and control, data exfiltration, and evasion of network defenses.\"\n",
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "High-Confidence TOR Node Network Indicators - Block Recommended - {{name}} ",
          "alertDescriptionFormat": "{{Description}} - {{name}} ",
          "alertDynamicProperties": [
            {
              "alertProperty": "ProductName",
              "value": "ProductName"
            },
            {
              "alertProperty": "ProviderName",
              "value": "ProviderName"
            }
          ]
        },
        "triggerOperator": "GreaterThan",
        "queryPeriod": "5m",
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "IPv4",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "columnName": "IPv6",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "columnName": "Domain",
                "identifier": "DomainName"
              }
            ],
            "entityType": "DNS"
          },
          {
            "fieldMappings": [
              {
                "columnName": "URL",
                "identifier": "Url"
              }
            ],
            "entityType": "URL"
          }
        ],
        "triggerThreshold": 0,
        "severity": "High",
        "customDetails": {
          "Description": "Description",
          "Created": "created",
          "ValidFrom": "valid_from",
          "IPAbuse": "IPAbuse",
          "ThreatType": "ThreatType",
          "Tags": "Tags",
          "IndicatorID": "IndicatorID",
          "Country": "Country",
          "TimeGenerated": "TimeGenerated",
          "Modified": "modified",
          "ConfidenceScore": "ConfidenceScore",
          "ThreatActors": "ThreatActors",
          "Sources": "Sources",
          "SecurityVendors": "SecurityVendors",
          "Roles": "Roles",
          "RecommendedActions": "RecommendedActions"
        },
        "suppressionEnabled": true,
        "query": "//TOR Node Network Indicators - Block Recommended\nlet timeFrame= 5m;\nCyfirmaIndicators_CL \n| where ConfidenceScore >= 80\n    and TimeGenerated between (ago(timeFrame) .. now())\n    and pattern !contains 'file:hashes' and RecommendedActions has 'Block' and Roles has 'TOR'\n| extend IPv4 = extract(@\"ipv4-addr:value\\s*=\\s*'([^']+)'\", 1, pattern)\n| extend IPv6 = extract(@\"ipv6-addr:value\\s*=\\s*'([^']+)'\", 1, pattern)\n| extend URL = extract(@\"url:value\\s*=\\s*'([^']+)'\", 1, pattern)\n| extend Domain = extract(@\"domain-name:value\\s*=\\s*'([^']+)'\", 1, pattern)\n| extend parsed = parse_json(extensions)\n| extend extensionKeys = bag_keys(parsed)\n| mv-expand extensionKeys\n| extend extensionKeyStr = tostring(extensionKeys)\n| extend ext = parsed[extensionKeyStr]\n| extend props = ext.properties\n| extend \n    extension_id = extensionKeyStr,\n    ASN_Owner = props.asn_owner,\n    ASN = props.asn,\n    ProviderName = 'CYFIRMA',\n    ProductName = 'DeCYFIR/DeTCT'\n| project\n    IPv4,\n    IPv6,\n    URL,\n    Domain,\n    ThreatActors,\n    RecommendedActions,\n    Sources,\n    Roles,\n    Country,\n    IPAbuse,\n    name,\n    Description,\n    ConfidenceScore,\n    IndicatorID,\n    created,\n    modified,\n    valid_from,\n    Tags,\n    ThreatType,\n    TimeGenerated,\n    SecurityVendors,\n    ProductName,\n    ProviderName\n",
        "tactics": [
          "CommandAndControl",
          "Exfiltration",
          "InitialAccess",
          "Persistence",
          "Reconnaissance"
        ],
        "suppressionDuration": "5m",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "name": "CYFIRMA - High severity TOR Node Network Indicators - Block Recommended Rule",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "matchingMethod": "AllEntities",
            "enabled": false,
            "reopenClosedIncident": false,
            "lookbackDuration": "5m"
          },
          "createIncident": true
        }
      }
    }
  ]
}
