{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/bf0cde21-0c41-48f6-a40c-6b5bd71fa106')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/bf0cde21-0c41-48f6-a40c-6b5bd71fa106')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "severity": "Medium",
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "Arn",
                "identifier": "Name"
              },
              {
                "columnName": "AWSAcoundId",
                "identifier": "ObjectGuid"
              }
            ]
          }
        ],
        "triggerThreshold": 0,
        "customDetails": {
          "ResourceTypeAffected": "ResourceTypeAffected",
          "ThreatPurpose": "ThreatPurpose",
          "UniqueFindingId": "UniqueFindingId"
        },
        "query": "AWSGuardDuty | extend tokens = split(ActivityType,\":\") | extend ThreatPurpose = tokens[0], tokens= split(tokens[1],\"/\") | extend ResourceTypeAffected = tokens[0], ThreatFamilyName= tokens[1] | extend UniqueFindingId = Id | extend AWSAcoundId = AccountId | project-away tokens,ActivityType, Id, AccountId | project-away TimeGenerated, TenantId, SchemaVersion, Region, Partition | extend Severity= iff(Severity between (7.0..8.9),\"High\",iff(Severity between (4.0..6.9), \"Medium\", iff(Severity between (1.0..3.9),\"Low\",\"Unknown\")))",
        "name": "AWS Guard Duty Alert",
        "status": "Available",
        "queryPeriod": "5h",
        "tactics": [],
        "description": "Amazon GuardDuty is a threat detection service that continuously monitors your AWS accounts and workloads for malicious activity and delivers detailed security findings for visibility and remediation. This templates create an alert for each Amazon GuardDuty finding.",
        "triggerOperator": "gt",
        "queryFrequency": "5h",
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "{{Title}}",
          "alertTacticsColumnName": "ThreatPurpose",
          "alertDescriptionFormat": "{{Description}}",
          "alertSeverityColumnName": "Severity"
        }
      }
    }
  ]
}
