{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/A667D635-D2A7-47E7-8827-8FB243AF2AFD')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/A667D635-D2A7-47E7-8827-8FB243AF2AFD')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "description": "'Generates Microsoft Sentinel incidents for SSL certificates nearing expiry as detected by Cyble. These alerts help identify certificate hygiene risks that may lead to service disruption or security issues. Severity is normalized using MappedSeverity for downstream automation.'\n",
        "enabled": true,
        "queryfrequency": "30m",
        "entityMappings": [
          {
            "entityType": "DNS",
            "fieldMappings": [
              {
                "identifier": "DomainName",
                "columnName": "SS_Asset"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "SS_Asset"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "SS_Port"
              }
            ]
          }
        ],
        "tactics": [
          "InitialAccess",
          "Impact"
        ],
        "severity": "Low",
        "triggerThreshold": 0,
        "triggerOperator": "GreaterThan",
        "status": "Available",
        "queryPeriod": "30m",
        "query": "Alerts_ssl_expiry\n| where Service == \"ssl_expiry\" \n| extend MappedSeverity = Severity\n",
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "lookbackDuration": "PT5H",
            "reopenClosedIncident": false,
            "matchingMethod": "AllEntities",
            "enabled": false
          },
          "alertDetailsOverride": null,
          "alertDescriptionFormat": "",
          "alertDisplayNameFormat": "SSL Certificate Expiry  {{DC_ServerName}}"
        },
        "customDetails": {
          "CertificateTitle": "SS_Title",
          "Status": "Status",
          "ExpiryDate": "SS_Expiry",
          "AlertID": "AlertID",
          "DaysToExpiry": "SS_DaysUntilExpiry",
          "Asset": "SS_Asset",
          "Port": "SS_Port",
          "Service": "Service",
          "MappedSeverity": "Severity"
        },
        "name": "Cyble Vision Alerts SSL Certificate Expiry"
      }
    }
  ]
}
