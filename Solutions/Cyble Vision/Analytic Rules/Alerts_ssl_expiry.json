{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/A667D635-D2A7-47E7-8827-8FB243AF2AFD')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/A667D635-D2A7-47E7-8827-8FB243AF2AFD')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "queryfrequency": "30m",
        "queryPeriod": "30m",
        "severity": "Low",
        "entityMappings": [
          {
            "entityType": "DNS",
            "fieldMappings": [
              {
                "columnName": "SS_Asset",
                "identifier": "DomainName"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "columnName": "SS_Asset",
                "identifier": "HostName"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "columnName": "SS_Port",
                "identifier": "HostName"
              }
            ]
          }
        ],
        "query": "Alerts_ssl_expiry\n| where Service == \"ssl_expiry\" \n| extend MappedSeverity = Severity\n",
        "enabled": true,
        "status": "Available",
        "customDetails": {
          "Asset": "SS_Asset",
          "AlertID": "AlertID",
          "DaysToExpiry": "SS_DaysUntilExpiry",
          "Service": "Service",
          "Port": "SS_Port",
          "CertificateTitle": "SS_Title",
          "MappedSeverity": "Severity",
          "Status": "Status",
          "ExpiryDate": "SS_Expiry"
        },
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Impact"
        ],
        "description": "'Generates Microsoft Sentinel incidents for SSL certificates nearing expiry as detected by Cyble. These alerts help identify certificate hygiene risks that may lead to service disruption or security issues. Severity is normalized using MappedSeverity for downstream automation.'\n",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "incidentConfiguration": {
          "alertDetailsOverride": null,
          "alertDescriptionFormat": "",
          "createIncident": true,
          "groupingConfiguration": {
            "enabled": false,
            "matchingMethod": "AllEntities",
            "lookbackDuration": "PT5H",
            "reopenClosedIncident": false
          },
          "alertDisplayNameFormat": "SSL Certificate Expiry  {{DC_ServerName}}"
        },
        "name": "Cyble Vision Alerts SSL Certificate Expiry"
      }
    }
  ]
}
