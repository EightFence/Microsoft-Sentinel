{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/A667D635-D2A7-47E7-8827-8FB243AF2AFD')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/A667D635-D2A7-47E7-8827-8FB243AF2AFD')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "queryPeriod": "30m",
        "enabled": true,
        "name": "Cyble Vision Alerts SSL Certificate Expiry",
        "severity": "Low",
        "triggerThreshold": 0,
        "description": "'Generates Microsoft Sentinel incidents for SSL certificates nearing expiry as detected by Cyble. These alerts help identify certificate hygiene risks that may lead to service disruption or security issues. Severity is normalized using MappedSeverity for downstream automation.'\n",
        "customDetails": {
          "CertificateTitle": "SS_Title",
          "ExpiryDate": "SS_Expiry",
          "Status": "Status",
          "Service": "Service",
          "Asset": "SS_Asset",
          "MappedSeverity": "Severity",
          "Port": "SS_Port",
          "DaysToExpiry": "SS_DaysUntilExpiry",
          "AlertID": "AlertID"
        },
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "matchingMethod": "AllEntities",
            "reopenClosedIncident": false,
            "enabled": false,
            "lookbackDuration": "PT5H"
          },
          "alertDisplayNameFormat": "SSL Certificate Expiry  {{DC_ServerName}}",
          "alertDetailsOverride": null,
          "alertDescriptionFormat": ""
        },
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "DomainName",
                "columnName": "SS_Asset"
              }
            ],
            "entityType": "DNS"
          },
          {
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "SS_Asset"
              }
            ],
            "entityType": "Host"
          },
          {
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "SS_Port"
              }
            ],
            "entityType": "Host"
          }
        ],
        "triggerOperator": "GreaterThan",
        "query": "Alerts_ssl_expiry\n| where Service == \"ssl_expiry\" \n| extend MappedSeverity = Severity\n",
        "status": "Available",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "queryfrequency": "30m",
        "tactics": [
          "InitialAccess",
          "Impact"
        ]
      }
    }
  ]
}
