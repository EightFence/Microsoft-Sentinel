{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/8e5f3a2c-9d1b-4c6e-a7f8-3b2d1e0c9a5f')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/8e5f3a2c-9d1b-4c6e-a7f8-3b2d1e0c9a5f')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "severity": "High",
        "queryFrequency": "15m",
        "tactics": [
          "InitialAccess",
          "Persistence",
          "DefenseEvasion",
          "Impact"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "AccountName",
                "identifier": "Name"
              },
              {
                "columnName": "UPNSuffix",
                "identifier": "UPNSuffix"
              }
            ]
          },
          {
            "entityType": "CloudApplication",
            "fieldMappings": [
              {
                "columnName": "CloudApp",
                "identifier": "Name"
              }
            ]
          }
        ],
        "alertDetailsOverride": {
          "alertDescriptionFormat": "{{MessageText}} by {{UserName}} in tenant {{Tenant}}.\n\nThis could indicate unauthorized access attempts or malicious removal of access controls.\n",
          "alertDisplayNameFormat": "SAP Build Work Zone: {{MessageText}}"
        },
        "status": "Available",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "queryPeriod": "15m",
        "triggerThreshold": 0,
        "triggerOperator": "gt",
        "query": "SAPBTPAuditLog_CL\n| extend LogMessage = coalesce(tostring(Message.message), tostring(Message.data), tostring(Message))\n| where LogMessage has_any (\"Unauthorized access to the oData service\", \n                            \"All roles for providerId\", \n                            \"All users for providerId\",\n                            \"were deleted successfully\",\n                            \"were removed successfully\")\n| extend EventCategory = case(\n    LogMessage contains \"Unauthorized access\", \"Unauthorized Access\",\n    LogMessage contains \"All roles\" or LogMessage contains \"All users\", \"Mass Deletion\",\n    \"Role Tampering\"\n)\n| extend MessageText = case(\n    LogMessage contains \"Unauthorized access to the oData service\", \"Unauthorized OData service access attempt\",\n    LogMessage contains \"All roles for providerId\" and LogMessage contains \"deleted\", \"Mass role deletion detected\",\n    LogMessage contains \"All users for providerId\" and LogMessage contains \"deleted\", \"Mass user deletion detected\",\n    LogMessage contains \"assignments were removed\", \"User/role assignments removed\",\n    \"Suspicious access control modification\"\n)\n| extend ProviderId = extract(@\"providerId\\s+(\\S+)\", 1, LogMessage)\n| project\n    TimeGenerated,\n    UserName,\n    MessageText,\n    EventCategory,\n    ProviderId,\n    Tenant,\n    CloudApp = \"SAP Build Work Zone Standard Edition\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
        "name": "BTP - Build Work Zone unauthorized access and role tampering",
        "customDetails": {
          "EventCategory": "EventCategory",
          "ProviderId": "ProviderId"
        },
        "description": "Identifies unauthorized OData access attempts and mass role/user deletions in SAP Build Work Zone \nStandard Edition. These events may indicate an attacker accessing restricted resources or \nremoving access controls to cover their tracks.\n"
      }
    }
  ]
}
