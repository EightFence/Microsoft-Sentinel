{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/9e6f4b2c-0d3e-5a8f-c9b7-2f5d8a1e4c6b')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/9e6f4b2c-0d3e-5a8f-c9b7-2f5d8a1e4c6b')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "triggerThreshold": 0,
        "queryPeriod": "15m",
        "triggerOperator": "gt",
        "status": "Available",
        "name": "BTP - Cloud Integration access policy tampering",
        "description": "Identifies changes to access policies in SAP Cloud Integration. Access policies control\nauthorization for integration artifacts, defining which users and roles can access specific\nintegration flows and related content.\n\nUnauthorized access policy manipulation could indicate:\n- Attacker granting themselves access to sensitive integration artifacts\n- Removal of security controls to enable further malicious activity\n- Defense evasion by modifying artifact references to hide unauthorized access\n",
        "queryFrequency": "15m",
        "alertDetailsOverride": {
          "alertDescriptionFormat": "{{MessageText}} by {{UserName}} from IP {{ipAddress}}.\n\nThis could indicate:\n- Legitimate access policy administration\n- Unauthorized privilege escalation attempt\n- Attacker modifying security controls to access sensitive integrations\n",
          "alertDisplayNameFormat": "SAP Cloud Integration: {{MessageText}}"
        },
        "tactics": [
          "DefenseEvasion",
          "PrivilegeEscalation"
        ],
        "query": "let accessPolicyTypes = dynamic([\"Access Policy\", \"Artifact Reference\"]);\nlet monitoredActions = dynamic([\"Create\", \"Change\", \"Delete\"]);\nSAPBTPAuditLog_CL\n| where Category == \"audit.security-events\"\n| extend data_s = tostring(Message.data),\n         ipAddress = tostring(Message.ip)\n| extend parsedData = parse_json(data_s)\n| extend action = tostring(parsedData.action),\n         objectType = tostring(parsedData.objectType),\n         objectId = tostring(parsedData.objectId),\n         policyMessage = tostring(parsedData.attributes.message)\n| where objectType in (accessPolicyTypes)\n| where action in (monitoredActions)\n| extend normalizedAction = case(\n    action == \"Create\", \"created\",\n    action == \"Change\", \"modified\",\n    action == \"Delete\", \"deleted\",\n    action\n)\n| extend MessageText = case(\n    objectType == \"Access Policy\", strcat(\"Access policy '\", objectId, \"' was \", normalizedAction),\n    objectType == \"Artifact Reference\", strcat(\"Artifact reference '\", objectId, \"' was \", normalizedAction),\n    strcat(objectType, \" '\", objectId, \"' was \", normalizedAction)\n)\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    ObjectType = objectType,\n    ObjectId = objectId,\n    Action = action,\n    PolicyMessage = policyMessage,\n    Tenant,\n    ipAddress,\n    CloudApp = \"SAP Cloud Integration\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "customDetails": {
          "ObjectId": "ObjectId",
          "ObjectType": "ObjectType",
          "PolicyMessage": "PolicyMessage",
          "Action": "Action",
          "SourceIP": "ipAddress"
        },
        "severity": "High",
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountName"
              },
              {
                "identifier": "UPNSuffix",
                "columnName": "UPNSuffix"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "ipAddress"
              }
            ]
          },
          {
            "entityType": "CloudApplication",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "CloudApp"
              }
            ]
          }
        ]
      }
    }
  ]
}
