{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/8b4a5c7e-2f91-4d8a-9e3b-1c6f8a2d4e9f')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/8b4a5c7e-2f91-4d8a-9e3b-1c6f8a2d4e9f')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "queryFrequency": "5m",
        "triggerOperator": "gt",
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "lookbackDuration": "P1D",
            "groupByEntities": [
              "Account",
              "Host"
            ],
            "reopenClosedIncident": false,
            "groupByAlertDetails": [
              "ThreatType",
              "DeviceGuid"
            ],
            "groupByCustomDetails": [
              "ThreatCategory",
              "DevicePlatform"
            ],
            "enabled": true,
            "matchingMethod": "Selected"
          }
        },
        "severity": "High",
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "FullName",
                "columnName": "DeviceEmailAddress"
              },
              {
                "identifier": "Name",
                "columnName": "TargetEmailAddress"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "DeviceGuid"
              },
              {
                "identifier": "OSFamily",
                "columnName": "DevicePlatform"
              },
              {
                "identifier": "OSVersion",
                "columnName": "DeviceOSVersion"
              }
            ]
          },
          {
            "entityType": "FileHash",
            "fieldMappings": [
              {
                "identifier": "Algorithm",
                "columnName": "ThreatApplicationName"
              },
              {
                "identifier": "Value",
                "columnName": "ThreatPackageSha"
              }
            ]
          }
        ],
        "suppressionDuration": "PT1H",
        "status": "Available",
        "description": "'Detects high severity mobile threats from Lookout Mobile Risk API v2 with enhanced threat intelligence and device context. This rule leverages the comprehensive v2 field set to provide detailed threat classification, risk assessment, and device compliance status for improved security monitoring.'\n",
        "customDetails": {
          "DevicePlatform": "DevicePlatform",
          "ComplianceImpact": "ComplianceImpact",
          "ThreatStatus": "ThreatStatus",
          "DeviceRiskLevel": "DeviceRiskLevel",
          "DeviceSecStatus": "DeviceSecurityStatus",
          "MDMConnectorId": "MDMConnectorId",
          "ThreatSeverity": "ThreatSeverity",
          "ThreatCategory": "ThreatCategory",
          "ThreatType": "ThreatType",
          "ThreatClasses": "ThreatClassifications",
          "ThreatRiskScore": "ThreatRiskScore"
        },
        "alertDetailsOverride": {
          "alertSeverityColumnName": "ThreatSeverity",
          "alertDisplayNameFormat": "High Severity Mobile Threat: {{ThreatType}} on {{DevicePlatform}} Device",
          "alertTacticsColumnName": "ThreatCategory",
          "alertDescriptionFormat": "{{ThreatSeverity}} {{ThreatCategory}} threat on {{DevicePlatform}}"
        },
        "query": "LookoutEvents\n| where EventType == \"THREAT\"\n| where ThreatSeverity in (\"CRITICAL\", \"HIGH\")\n| where ThreatAction == \"DETECTED\"\n| where ThreatStatus in (\"OPEN\", \"ACTIVE\")\n| extend \n    ThreatRiskScore = case(\n        ThreatSeverity == \"CRITICAL\", 10,\n        ThreatSeverity == \"HIGH\", 8,\n        ThreatSeverity == \"MEDIUM\", 5,\n        ThreatSeverity == \"LOW\", 2,\n        1\n    ),\n    DeviceRiskLevel = case(\n        DeviceSecurityStatus == \"THREATS_HIGH\", \"High\",\n        DeviceSecurityStatus == \"THREATS_MEDIUM\", \"Medium\",\n        DeviceSecurityStatus == \"THREATS_LOW\", \"Low\",\n        \"Unknown\"\n    ),\n    ThreatCategory = case(\n        ThreatClassifications has \"MALWARE\", \"Malware\",\n        ThreatClassifications has \"PHISHING\", \"Phishing\", \n        ThreatClassifications has \"SPYWARE\", \"Spyware\",\n        ThreatClassifications has \"TROJAN\", \"Trojan\",\n        ThreatClassifications has \"ADWARE\", \"Adware\",\n        \"Other\"\n    )\n| extend ComplianceImpact = case(\n    DeviceComplianceStatus == \"Non-Compliant\" and ThreatRiskScore >= 8, \"Critical\",\n    DeviceComplianceStatus == \"Non-Compliant\" and ThreatRiskScore >= 5, \"High\", \n    DeviceComplianceStatus == \"Partial\" and ThreatRiskScore >= 8, \"High\",\n    DeviceComplianceStatus == \"Partial\" and ThreatRiskScore >= 5, \"Medium\",\n    \"Low\"\n)\n| project\n    TimeGenerated,\n    EventId,\n    ThreatId,\n    ThreatType,\n    ThreatSeverity,\n    ThreatRiskScore,\n    ThreatCategory,\n    ThreatClassifications,\n    ThreatStatus,\n    ThreatDescription,\n    ThreatApplicationName,\n    ThreatPackageName,\n    ThreatPackageSha,\n    DeviceGuid,\n    DevicePlatform,\n    DeviceOSVersion,\n    DeviceManufacturer,\n    DeviceModel,\n    DeviceEmailAddress,\n    DeviceSecurityStatus,\n    DeviceRiskLevel,\n    DeviceComplianceStatus,\n    ComplianceImpact,\n    ClientLookoutSDKVersion,\n    MDMConnectorId,\n    MDMExternalId,\n    TargetEmailAddress,\n    TargetPlatform,\n    ActorType,\n    ActorGuid\n",
        "suppressionEnabled": false,
        "name": "Lookout - High Severity Mobile Threats Detected (v2)",
        "queryPeriod": "15m",
        "triggerThreshold": 0,
        "tactics": [
          "Discovery",
          "DefenseEvasion",
          "Persistence",
          "PrivilegeEscalation"
        ],
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        }
      }
    }
  ]
}
