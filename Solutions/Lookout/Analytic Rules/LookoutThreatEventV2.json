{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/8b4a5c7e-2f91-4d8a-9e3b-1c6f8a2d4e9f')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/8b4a5c7e-2f91-4d8a-9e3b-1c6f8a2d4e9f')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "suppressionEnabled": false,
        "triggerThreshold": 0,
        "query": "LookoutEvents\n| where EventType == \"THREAT\"\n| where ThreatSeverity in (\"CRITICAL\", \"HIGH\")\n| where ThreatAction == \"DETECTED\"\n| where ThreatStatus in (\"OPEN\", \"ACTIVE\")\n| extend \n    ThreatRiskScore = case(\n        ThreatSeverity == \"CRITICAL\", 10,\n        ThreatSeverity == \"HIGH\", 8,\n        ThreatSeverity == \"MEDIUM\", 5,\n        ThreatSeverity == \"LOW\", 2,\n        1\n    ),\n    DeviceRiskLevel = case(\n        DeviceSecurityStatus == \"THREATS_HIGH\", \"High\",\n        DeviceSecurityStatus == \"THREATS_MEDIUM\", \"Medium\",\n        DeviceSecurityStatus == \"THREATS_LOW\", \"Low\",\n        \"Unknown\"\n    ),\n    ThreatCategory = case(\n        ThreatClassifications has \"MALWARE\", \"Malware\",\n        ThreatClassifications has \"PHISHING\", \"Phishing\", \n        ThreatClassifications has \"SPYWARE\", \"Spyware\",\n        ThreatClassifications has \"TROJAN\", \"Trojan\",\n        ThreatClassifications has \"ADWARE\", \"Adware\",\n        \"Other\"\n    )\n| extend ComplianceImpact = case(\n    DeviceComplianceStatus == \"Non-Compliant\" and ThreatRiskScore >= 8, \"Critical\",\n    DeviceComplianceStatus == \"Non-Compliant\" and ThreatRiskScore >= 5, \"High\", \n    DeviceComplianceStatus == \"Partial\" and ThreatRiskScore >= 8, \"High\",\n    DeviceComplianceStatus == \"Partial\" and ThreatRiskScore >= 5, \"Medium\",\n    \"Low\"\n)\n| project\n    TimeGenerated,\n    EventId,\n    ThreatId,\n    ThreatType,\n    ThreatSeverity,\n    ThreatRiskScore,\n    ThreatCategory,\n    ThreatClassifications,\n    ThreatStatus,\n    ThreatDescription,\n    ThreatApplicationName,\n    ThreatPackageName,\n    ThreatPackageSha,\n    DeviceGuid,\n    DevicePlatform,\n    DeviceOSVersion,\n    DeviceManufacturer,\n    DeviceModel,\n    DeviceEmailAddress,\n    DeviceSecurityStatus,\n    DeviceRiskLevel,\n    DeviceComplianceStatus,\n    ComplianceImpact,\n    ClientLookoutSDKVersion,\n    MDMConnectorId,\n    MDMExternalId,\n    TargetEmailAddress,\n    TargetPlatform,\n    ActorType,\n    ActorGuid\n",
        "queryPeriod": "15m",
        "triggerOperator": "gt",
        "status": "Available",
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "FullName",
                "columnName": "DeviceEmailAddress"
              },
              {
                "identifier": "Name",
                "columnName": "TargetEmailAddress"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "DeviceGuid"
              },
              {
                "identifier": "OSFamily",
                "columnName": "DevicePlatform"
              },
              {
                "identifier": "OSVersion",
                "columnName": "DeviceOSVersion"
              }
            ]
          },
          {
            "entityType": "FileHash",
            "fieldMappings": [
              {
                "identifier": "Algorithm",
                "columnName": "ThreatApplicationName"
              },
              {
                "identifier": "Value",
                "columnName": "ThreatPackageSha"
              }
            ]
          }
        ],
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "lookbackDuration": "P1D",
            "reopenClosedIncident": false,
            "groupByCustomDetails": [
              "ThreatCategory",
              "DevicePlatform"
            ],
            "groupByAlertDetails": [
              "ThreatType",
              "DeviceGuid"
            ],
            "matchingMethod": "Selected",
            "enabled": true,
            "groupByEntities": [
              "Account",
              "Host"
            ]
          }
        },
        "customDetails": {
          "DeviceSecStatus": "DeviceSecurityStatus",
          "ThreatStatus": "ThreatStatus",
          "ThreatRiskScore": "ThreatRiskScore",
          "ThreatClasses": "ThreatClassifications",
          "ThreatCategory": "ThreatCategory",
          "ThreatSeverity": "ThreatSeverity",
          "MDMConnectorId": "MDMConnectorId",
          "DeviceRiskLevel": "DeviceRiskLevel",
          "DevicePlatform": "DevicePlatform",
          "ThreatType": "ThreatType",
          "ComplianceImpact": "ComplianceImpact"
        },
        "description": "'Detects high severity mobile threats from Lookout Mobile Risk API v2 with enhanced threat intelligence and device context. This rule leverages the comprehensive v2 field set to provide detailed threat classification, risk assessment, and device compliance status for improved security monitoring.'\n",
        "severity": "High",
        "tactics": [
          "Discovery",
          "DefenseEvasion",
          "Persistence",
          "PrivilegeEscalation"
        ],
        "suppressionDuration": "PT1H",
        "queryFrequency": "5m",
        "name": "Lookout - High Severity Mobile Threats Detected (v2)",
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "High Severity Mobile Threat: {{ThreatType}} on {{DevicePlatform}} Device",
          "alertTacticsColumnName": "ThreatCategory",
          "alertDescriptionFormat": "{{ThreatSeverity}} {{ThreatCategory}} threat on {{DevicePlatform}}",
          "alertSeverityColumnName": "ThreatSeverity"
        },
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        }
      }
    }
  ]
}
