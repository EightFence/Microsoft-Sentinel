{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/7a3e5f9b-4c8d-4a2e-9f1b-6d8e2a4c7f9e')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/7a3e5f9b-4c8d-4a2e-9f1b-6d8e2a4c7f9e')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "triggerThreshold": 0,
        "triggerOperator": "gt",
        "suppressionEnabled": false,
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "DeviceEmailAddress",
                "identifier": "FullName"
              },
              {
                "columnName": "TargetEmailAddress",
                "identifier": "Name"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "columnName": "DeviceGuid",
                "identifier": "HostName"
              },
              {
                "columnName": "DevicePlatform",
                "identifier": "OSFamily"
              },
              {
                "columnName": "DeviceOSVersion",
                "identifier": "OSVersion"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "columnName": "SmishingAlertDescription",
                "identifier": "Url"
              }
            ]
          }
        ],
        "query": "LookoutEvents\n| where EventType == \"SMISHING_ALERT\"\n| where SmishingAlertSeverity in (\"CRITICAL\", \"HIGH\")\n| where SmishingAlertType in (\"PHISHING_DETECTION\", \"FRAUD_DETECTION\", \"CREDENTIAL_HARVESTING\")\n| extend \n    AlertRiskScore = case(\n        SmishingAlertSeverity == \"CRITICAL\", 10,\n        SmishingAlertSeverity == \"HIGH\", 8,\n        SmishingAlertSeverity == \"MEDIUM\", 5,\n        SmishingAlertSeverity == \"LOW\", 2,\n        1\n    ),\n    ThreatCategory = case(\n        SmishingAlertType == \"PHISHING_DETECTION\", \"Phishing\",\n        SmishingAlertType == \"FRAUD_DETECTION\", \"Fraud\",\n        SmishingAlertType == \"CREDENTIAL_HARVESTING\", \"Credential Theft\",\n        SmishingAlertType == \"MALICIOUS_LINK\", \"Malicious Link\",\n        \"Other\"\n    ),\n    ImpersonationRisk = case(\n        SmishingAlertDescription has \"CEO\" or SmishingAlertDescription has \"executive\", \"Executive Impersonation\",\n        SmishingAlertDescription has \"IT\" or SmishingAlertDescription has \"support\", \"IT Support Impersonation\", \n        SmishingAlertDescription has \"bank\" or SmishingAlertDescription has \"financial\", \"Financial Impersonation\",\n        SmishingAlertDescription has \"delivery\" or SmishingAlertDescription has \"package\", \"Delivery Impersonation\",\n        \"Generic Phishing\"\n    )\n| extend DeviceRiskLevel = case(\n    DeviceSecurityStatus == \"THREATS_HIGH\", \"High\",\n    DeviceSecurityStatus == \"THREATS_MEDIUM\", \"Medium\", \n    DeviceSecurityStatus == \"THREATS_LOW\", \"Low\",\n    \"Unknown\"\n)\n| extend CampaignIndicators = case(\n    AlertRiskScore >= 8 and DeviceRiskLevel == \"High\", \"Targeted Campaign\",\n    AlertRiskScore >= 6 and ImpersonationRisk != \"Generic Phishing\", \"Sophisticated Attack\",\n    AlertRiskScore >= 5, \"Coordinated Threat\",\n    \"Isolated Incident\"\n)\n| project\n    TimeGenerated,\n    EventId,\n    SmishingAlertId,\n    SmishingAlertType,\n    SmishingAlertSeverity,\n    SmishingAlertDescription,\n    AlertRiskScore,\n    ThreatCategory,\n    ImpersonationRisk,\n    CampaignIndicators,\n    DeviceGuid,\n    DevicePlatform,\n    DeviceOSVersion,\n    DeviceManufacturer,\n    DeviceModel,\n    DeviceEmailAddress,\n    DeviceSecurityStatus,\n    DeviceRiskLevel,\n    TargetEmailAddress,\n    TargetPlatform,\n    ActorType,\n    ActorGuid,\n    ChangeType\n",
        "tactics": [
          "InitialAccess",
          "CredentialAccess",
          "Collection",
          "Discovery"
        ],
        "suppressionDuration": "PT1H",
        "queryFrequency": "5m",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "groupByAlertDetails": [
              "SmishAlertType",
              "DeviceGuid"
            ],
            "lookbackDuration": "P1D",
            "enabled": true,
            "matchingMethod": "Selected",
            "reopenClosedIncident": false,
            "groupByCustomDetails": [
              "ThreatCategory",
              "ImpersonationRisk",
              "CampaignIndicators"
            ],
            "groupByEntities": [
              "Account",
              "Host"
            ]
          },
          "createIncident": true
        },
        "name": "Lookout - Critical Smishing and Phishing Alerts (v2)",
        "description": "'Detects critical smishing (SMS phishing) and phishing alerts from Lookout Mobile Risk API v2. This rule identifies sophisticated social engineering attacks including CEO fraud, credential harvesting, and malicious link campaigns targeting mobile devices. Leverages enhanced v2 smishing detection capabilities for comprehensive mobile threat protection.'\n",
        "customDetails": {
          "DevicePlatform": "DevicePlatform",
          "CampaignIndicators": "CampaignIndicators",
          "DeviceRiskLevel": "DeviceRiskLevel",
          "ImpersonationRisk": "ImpersonationRisk",
          "AlertRiskScore": "AlertRiskScore",
          "SmishSeverity": "SmishingAlertSeverity",
          "ThreatCategory": "ThreatCategory",
          "DeviceSecStatus": "DeviceSecurityStatus",
          "SmishAlertType": "SmishingAlertType"
        },
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "severity": "High",
        "queryPeriod": "15m",
        "alertDetailsOverride": {
          "alertTacticsColumnName": "ThreatCategory",
          "alertSeverityColumnName": "SmishingAlertSeverity",
          "alertDisplayNameFormat": "Critical Smishing Alert: {{ThreatCategory}} targeting {{DevicePlatform}} Device",
          "alertDescriptionFormat": "{{SmishingAlertSeverity}} {{ThreatCategory}} attack on {{DevicePlatform}}"
        },
        "status": "Available"
      }
    }
  ]
}
