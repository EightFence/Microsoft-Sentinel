{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/b8a3c5e2-04d5-4b61-9b62-b4f53a417f74')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/b8a3c5e2-04d5-4b61-9b62-b4f53a417f74')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "name": "CYFIRMA - Attack Surface - Cloud Weakness Medium Rule",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "reopenClosedIncident": false,
            "matchingMethod": "AllEntities",
            "lookbackDuration": "PT5H",
            "enabled": false
          },
          "createIncident": true
        },
        "severity": "Medium",
        "triggerOperator": "gt",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "triggerThreshold": 0,
        "queryFrequency": "5m",
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "Domain",
                "identifier": "DomainName"
              }
            ],
            "entityType": "DNS"
          }
        ],
        "status": "Available",
        "description": "\"This rule detects cloud storage buckets (e.g., AWS S3) that are publicly accessible without authentication. \nSuch misconfigurations can lead to data exfiltration, compliance violations, and reputational damage. \nThe detection is based on Cyfirma's Attack Surface Intelligence.\"\n",
        "tactics": [
          "InitialAccess",
          "Collection",
          "Discovery",
          "Exfiltration"
        ],
        "query": "// Medium Severity - Attack Surface - Cloud Weakness - Unauthorized Public Cloud Storage Exposure Detected\nlet timeFrame = 5m;\nCyfirmaASCloudWeaknessAlerts_CL\n| where severity == 'High' and TimeGenerated between (ago(timeFrame) .. now())\n| extend\n    Description=description,\n    FirstSeen=first_seen,\n    LastSeen=last_seen,\n    RiskScore=risk_score,\n    Domain=asset_name,\n    AlertUID=alert_uid,\n    UID=uid,\n    Source=source,\n    SourceType=source_type,\n    CreatedDate=created_date,\n    Impact=impact,\n    ProviderName='CYFIRMA',\n    ProductName='DeCYFIR/DeTCT'\n| project\n    TimeGenerated,\n    Description,\n    Domain,\n    RiskScore,\n    FirstSeen,\n    LastSeen,\n    AlertUID,\n    UID,\n    Source,\n    SourceType,\n    CreatedDate,\n    Impact,\n    ProviderName,\n    ProductName\n",
        "customDetails": {
          "SourceType": "SourceType",
          "Source": "Source",
          "AlertUID": "AlertUID",
          "RiskScore": "RiskScore",
          "Impact": "Impact",
          "LastSeen": "LastSeen",
          "FirstSeen": "FirstSeen",
          "UID": "UID",
          "CreatedDate": "CreatedDate",
          "TimeGenerated": "TimeGenerated"
        },
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "CYFIRMA - Medium Severity Alert - Unauthorized Public Cloud Storage Exposure Detected - Domain: {{Domain}}",
          "alertDescriptionFormat": "CYFIRMA - Medium Severity Alert - Unauthorized Public Cloud Storage Exposure Detected - {{Description}}",
          "alertDynamicProperties": [
            {
              "value": "ProductName",
              "alertProperty": "ProductName"
            },
            {
              "value": "ProviderName",
              "alertProperty": "ProviderName"
            }
          ]
        },
        "queryPeriod": "5m"
      }
    }
  ]
}
