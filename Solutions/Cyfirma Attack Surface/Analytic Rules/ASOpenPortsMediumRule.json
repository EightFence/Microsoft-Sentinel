{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/9e18b6c3-d172-4bc6-a7d9-cc7b0a03a69e')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/9e18b6c3-d172-4bc6-a7d9-cc7b0a03a69e')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "triggerThreshold": 0,
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "CYFIRMA - Medium Severity Open Ports Exposure Detected on Assets - Domain: {{Domain}}, IP: {{NetworkIP}}",
          "alertDescriptionFormat": "CYFIRMA - Medium Severity Open Ports Exposure Detected on Assets - {{Description}}",
          "alertDynamicProperties": [
            {
              "alertProperty": "ProductName",
              "value": "DeCYFIR/DeTCT"
            },
            {
              "alertProperty": "ProviderName",
              "value": "CYFIRMA"
            }
          ]
        },
        "queryPeriod": "5m",
        "query": "// Medium Severity - Open Ports Exposure Detected\nlet timeFrame = 5m;\nCyfirmaASOpenPortsAlerts_CL\n| where severity == 'High' and TimeGenerated between (ago(timeFrame) .. now())\n| extend \n    Description=description, \n    FirstSeen=first_seen, \n    LastSeen=last_seen, \n    RiskScore=risk_score, \n    Domain=sub_domain, \n    TopDomain=top_domain, \n    NetworkIP=ip, \n    AlertUID=alert_uid, \n    UID=uid, \n    WebServer=web_server, \n    WebServerVersion=web_server_version, \n    OpenPorts=open_ports, \n    ProviderName='CYFIRMA', \n    ProductName='DeCYFIR/DeTCT'\n| project\n    TimeGenerated,\n    Description,\n    Domain,\n    TopDomain,\n    RiskScore,\n    FirstSeen,\n    LastSeen,\n    NetworkIP,\n    AlertUID,\n    UID,\n    WebServer,\n    WebServerVersion,\n    OpenPorts,\n    ProductName,\n    ProviderName\n",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "enabled": false,
            "lookbackDuration": "5h",
            "matchingMethod": "AllEntities",
            "reopenClosedIncident": false
          },
          "createIncident": true
        },
        "severity": "Medium",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "triggerOperator": "gt",
        "description": "\"This rule is triggered when CYFIRMA identifies open and publicly accessible ports on internet-facing assets. Exposed services may include SSH, RDP, HTTP, or other potentially sensitive ports, increasing the risk of unauthorized access, exploitation, or reconnaissance by threat actors. Monitoring open ports is critical to reducing the external attack surface and preventing misuse through brute force, service vulnerabilities, or protocol exploitation.\"\n",
        "name": "CYFIRMA - Attack Surface - Open Ports Medium Rule",
        "queryFrequency": "5m",
        "customDetails": {
          "TimeGenerated": "TimeGenerated",
          "OpenPorts": "OpenPorts",
          "FirstSeen": "FirstSeen",
          "Description": "Description",
          "WebServerVersion": "WebServerVersion",
          "LastSeen": "LastSeen",
          "UID": "UID",
          "AlertUID": "AlertUID",
          "WebServer": "WebServer",
          "RiskScore": "RiskScore"
        },
        "status": "Available",
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "DomainName",
                "columnName": "Domain"
              }
            ],
            "entityType": "DNS"
          },
          {
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "TopDomain"
              },
              {
                "identifier": "DnsDomain",
                "columnName": "Domain"
              }
            ],
            "entityType": "Host"
          },
          {
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "NetworkIP"
              }
            ],
            "entityType": "IP"
          }
        ],
        "tactics": [
          "InitialAccess",
          "CommandAndControl",
          "Discovery",
          "DefenseEvasion",
          "Persistence"
        ]
      }
    }
  ]
}
