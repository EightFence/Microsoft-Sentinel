{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/87cd8b10-90f6-4967-a4a7-2142e848ec8f')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/87cd8b10-90f6-4967-a4a7-2142e848ec8f')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "description": "\"This rule detects cloud storage buckets (e.g., AWS S3) that are publicly accessible without authentication. \nSuch misconfigurations can lead to data exfiltration, compliance violations, and reputational damage. \nThe detection is based on Cyfirma's Attack Surface Intelligence.\"\n",
        "triggerThreshold": 0,
        "name": "CYFIRMA - Attack Surface - Cloud Weakness High Rule",
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "Domain",
                "identifier": "DomainName"
              }
            ],
            "entityType": "DNS"
          }
        ],
        "query": "// High Severity - Attack Surface - Cloud Weakness - Unauthorized Public Cloud Storage Exposure Detected\nlet timeFrame = 5m;\nCyfirmaASCloudWeaknessAlerts_CL\n| where severity == 'Critical' and TimeGenerated between (ago(timeFrame) .. now())\n| extend\n    Description=description,\n    FirstSeen=first_seen,\n    LastSeen=last_seen,\n    RiskScore=risk_score,\n    Domain=asset_name,\n    AlertUID=alert_uid,\n    UID=uid,\n    Source=source,\n    SourceType=source_type,\n    CreatedDate=created_date,\n    Impact=impact,\n    ProviderName='CYFIRMA',\n    ProductName='DeCYFIR/DeTCT'\n| project\n    TimeGenerated,\n    Description,\n    Domain,\n    RiskScore,\n    FirstSeen,\n    LastSeen,\n    AlertUID,\n    UID,\n    Source,\n    SourceType,\n    CreatedDate,\n    Impact,\n    ProviderName,\n    ProductName\n",
        "incidentConfiguration": {
          "groupingConfiguration": {
            "enabled": false,
            "lookbackDuration": "PT5H",
            "reopenClosedIncident": false,
            "matchingMethod": "AllEntities"
          },
          "createIncident": true
        },
        "queryPeriod": "5m",
        "tactics": [
          "InitialAccess",
          "Collection",
          "Discovery",
          "Exfiltration"
        ],
        "customDetails": {
          "SourceType": "SourceType",
          "CreatedDate": "CreatedDate",
          "TimeGenerated": "TimeGenerated",
          "RiskScore": "RiskScore",
          "Source": "Source",
          "Impact": "Impact",
          "AlertUID": "AlertUID",
          "LastSeen": "LastSeen",
          "UID": "UID",
          "FirstSeen": "FirstSeen"
        },
        "triggerOperator": "gt",
        "alertDetailsOverride": {
          "alertDescriptionFormat": "CYFIRMA - High Severity Alert - Unauthorized Public Cloud Storage Exposure Detected - {{Description}} ",
          "alertDisplayNameFormat": "CYFIRMA - High Severity Alert - Unauthorized Public Cloud Storage Exposure Detected - Domain: {{Domain}} ",
          "alertDynamicProperties": [
            {
              "alertProperty": "ProductName",
              "value": "ProductName"
            },
            {
              "alertProperty": "ProviderName",
              "value": "ProviderName"
            }
          ]
        },
        "queryFrequency": "5m",
        "severity": "High",
        "status": "Available",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        }
      }
    }
  ]
}
