{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/a9c7a4be-b7e7-4045-8028-0d1ffaa049af')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a9c7a4be-b7e7-4045-8028-0d1ffaa049af')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "triggerThreshold": 0,
        "status": "Available",
        "queryPeriod": "1h",
        "alertDetailsOverride": {
          "alertDescriptionFormat": "DNSSEC is disabled for managed zone {{ManagedZone}} in project {{ProjectName}}. Review the zone configuration and enable DNSSEC where appropriate.",
          "alertDisplayNameFormat": "GCP DNS zone {{ManagedZone}} has DNSSEC disabled"
        },
        "triggerOperator": "gt",
        "entityMappings": [
          {
            "entityType": "CloudApplication",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "ResourceName"
              }
            ]
          }
        ],
        "description": "Detects Google Cloud DNS zones where DNSSEC is disabled using Security Command Center findings (DNSSEC_DISABLED).\nDisabling DNSSEC increases risk of DNS hijacking and man-in-the-middle attacks. This analytic rule alerts on findings where DNSSEC is reported as disabled for a managed zone.\n",
        "tactics": [
          "Collection",
          "CommandAndControl",
          "DefenseEvasion"
        ],
        "name": "GCP Security Command Center - Detect DNSSEC disabled for DNS zones",
        "severity": "Medium",
        "queryFrequency": "1h",
        "query": "GoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingsJson = parse_json(Findings)\n| extend FindingCategory = tostring(FindingsJson.category)\n| where FindingCategory == \"DNSSEC_DISABLED\"\n| extend ResourceName = tostring(FindingsJson.resourceName)\n| extend\n  ResourceType = tostring(FindingsResource.type),\n  ExternalUri = tostring(FindingsJson.externalUri),\n  SourceProps = parse_json(tostring(FindingsJson.sourceProperties)),\n  GcpResource = parse_json(tostring(FindingsJson.resource))\n// Extract project and managed zone from resourceName like //dns.googleapis.com/projects/PROJECT/managedZones/ZONE\n| extend ProjectName = extract(@\"projects/([^/]+)\", 1, ResourceName)\n| extend ManagedZone = extract(@\"managedZones/([^/]+)\", 1, ResourceName)\n| extend Severity = tostring(FindingsJson.severity)\n| summarize\n  TimeGenerated = max(TimeGenerated)\n  by ProjectName, ManagedZone, ResourceType, ResourceName, Severity, ExternalUri\n",
        "customDetails": {
          "ExternalUri": "ExternalUri",
          "ManagedZone": "ManagedZone",
          "ProjectName": "ProjectName"
        }
      }
    }
  ]
}
