{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/317e757e-c320-448e-8837-fc61a70fe609')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/317e757e-c320-448e-8837-fc61a70fe609')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "enabled": true,
        "queryPeriod": "5m",
        "queryFrequency": "5m",
        "severity": "Medium",
        "triggerOperator": "gt",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "tactics": [
          "DefenseEvasion",
          "Impact"
        ],
        "entityMappings": null,
        "query": "let CommvaultData = union isfuzzy=true\n    (CommvaultSecurityIQ_CL | where TimeGenerated > ago(5m)),\n    (datatable(TimeGenerated:datetime, eventCodeString_s:string, Event_Code_s:string, description_s:string, Description_s:string, id_d:real, Event_Id_s:string)[]);\nCommvaultData\n| where isnotempty(TimeGenerated)\n| where eventCodeString_s in (\"7:211\", \"7:212\", \"7:293\", \"7:269\", \"14:337\", \"14:338\", \"69:59\", \"7:333\", \"69:60\", \"35:5575\")\n    or Event_Code_s in (\"7:211\", \"7:212\", \"7:293\", \"7:269\", \"14:337\", \"14:338\", \"69:59\", \"7:333\", \"69:60\", \"35:5575\")\n| extend Description = coalesce(description_s, Description_s, \"\")\n| extend EventId = coalesce(tostring(toint(id_d)), Event_Id_s, \"\")\n| extend ClientMachine = case(\n    Description contains \"on the machine\", extract(@\"on the machine \\[([^\\]]+)\\]\", 1, Description),\n    Description contains \"on client\", extract(@\"on client \\[([^\\]]+)\\]\", 1, Description),\n    Description contains \"for client\", extract(@\"for client \\[([^\\]]+)\\]\", 1, Description),\n    Description contains \"client\", extract(@\"client \\[([^\\]]+)\\]\", 1, Description),\n    Description contains \"machine\", extract(@\"machine \\[([^\\]]+)\\]\", 1, Description),\n    \"Unknown\"\n)\n| project TimeGenerated, eventCodeString_s, Event_Code_s, EventId, Description, ClientMachine, Event_Id_s, id_d\n| take 1000\n",
        "alertDetailsOverride": {
          "alertDescriptionFormat": "Alert from Commvault Cloud for Event ID :  {{id_d}} . Event Description : {{Description}}  . Check the event description on Commvault Command Center for more details.",
          "alertDynamicProperties": [],
          "alertDisplayNameFormat": "Alert from Commvault Cloud for Event ID :  {{id_d}} "
        },
        "name": "Commvault Cloud Alert",
        "customDetails": {
          "Client": "ClientMachine"
        },
        "triggerThreshold": 0,
        "description": "'This query identifies Alerts from Commvault Cloud.'\n",
        "status": "Available"
      }
    }
  ]
}
