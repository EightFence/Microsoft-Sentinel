{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/ebd1bf8d-aa18-4e66-9cad-555b71a290f1')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ebd1bf8d-aa18-4e66-9cad-555b71a290f1')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "name": "CYFIRMA - Customer Accounts Leaks Detection Rule",
        "tactics": [
          "CredentialAccess",
          "InitialAccess"
        ],
        "alertDetailsOverride": {
          "alertDescriptionFormat": "{{description}}",
          "alertDynamicProperties": [
            {
              "alertProperty": "ProductName",
              "value": "ProductName"
            },
            {
              "alertProperty": "ProviderName",
              "value": "ProviderName"
            }
          ],
          "alertDisplayNameFormat": "Customer Leak - {{user_name}} - {{email}}"
        },
        "queryPeriod": "5m",
        "triggerThreshold": 0,
        "triggerOperator": "gt",
        "description": "\"Detects recent leaks of customer account credentials based on CYFIRMA's threat intelligence.\n  This rule surfaces the latest credential exposures, including email, username, and breach metadata.\n  It enables security teams to quickly identify and investigate leaked customer data from third-party breaches, dark web listings, or public repositories.\"\n",
        "query": "// Customer Accounts Leaks - Latest per UID\nlet timeFrame = 5m;\nCyfirmaCompromisedAccounts_CL\n| where TimeGenerated between (ago(timeFrame) .. now())\n    and Category has \"Customer Accounts Leaks\"\n| extend \n    ProviderName = 'CYFIRMA',\n    ProductName = 'DeCYFIR/DeTCT'\n| summarize arg_max(TimeGenerated, \n    user_name,\n    email,\n    url,\n    password,\n    breach_date,\n    first_seen,\n    last_seen,\n    impact,\n    recommendations,\n    description,\n    source,\n    ProductName,\n    ProviderName\n) by uid\n| sort by TimeGenerated desc\n",
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "lookbackDuration": "PT5H",
            "reopenClosedIncident": false,
            "matchingMethod": "AllEntities",
            "enabled": false
          }
        },
        "suppressionEnabled": true,
        "status": "Available",
        "customDetails": {
          "TimeGenerated": "TimeGenerated",
          "UID": "uid",
          "Source": "source",
          "BreachDate": "breach_date",
          "LastSeen": "last_seen",
          "FirstSeen": "first_seen",
          "Recommendations": "recommendations",
          "Impact": "impact",
          "Description": "description"
        },
        "suppressionDuration": "6h",
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "user_name",
                "identifier": "Name"
              },
              {
                "columnName": "email",
                "identifier": "UPNSuffix"
              }
            ]
          },
          {
            "entityType": "URL",
            "fieldMappings": [
              {
                "columnName": "url",
                "identifier": "Url"
              }
            ]
          }
        ],
        "severity": "High",
        "queryFrequency": "5m"
      }
    }
  ]
}
