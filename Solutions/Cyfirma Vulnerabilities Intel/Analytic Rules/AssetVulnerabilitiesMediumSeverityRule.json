{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/6306f2d9-34a3-409a-850d-175b7bdd1ab1')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/6306f2d9-34a3-409a-850d-175b7bdd1ab1')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "alertDetailsOverride": null,
        "tactics": [
          "Execution",
          "LateralMovement",
          "PrivilegeEscalation",
          "InitialAccess",
          "CredentialAccess",
          "DefenseEvasion"
        ],
        "queryPeriod": "5m",
        "triggerThreshold": 0,
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "queryFrequency": "5m",
        "customDetails": {
          "Products": "products",
          "AttackVector": "attack_vector",
          "AttackComplexity": "attack_complexity",
          "ExploitabilityScore": "exploitability_score",
          "UserInteraction": "user_interaction",
          "CVE": "name",
          "IntegrityImpact": "integrity_impact",
          "Modified": "modified",
          "ConfidentialImpact": "confidentiality_impact",
          "CVSSVector": "cvss_vector",
          "TimeGenerated": "TimeGenerated",
          "Vendors": "vendors",
          "ImpactScore": "impact_score",
          "PrivilegesRequired": "privileges_required",
          "CVSSScore": "cvss_score",
          "scope": "scope",
          "Technologies": "technologies",
          "ConfidenceScore": "confidence_score",
          "CVSSVersion": "cvss_version"
        },
        "alertDescriptionFormat": "{{description}} ",
        "triggerOperator": "GreaterThan",
        "alertDisplayNameFormat": "CYFIRMA - Medium Severity Asset based Vulnerability Identified - {{name}} ",
        "description": "\"This rule detects medium severity asset-based vulnerabilities from CYFIRMA's vulnerability intelligence data. \nIt identifies vulnerabilities with a confidence score of 50 or higher, excluding those categorized as 'ATTACK_SURFACE_VULNERABILITY', and generates alerts for assets that may be at risk.\"\n",
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "enabled": false,
            "reopenClosedIncident": false,
            "lookbackDuration": "5m",
            "matchingMethod": "AllEntities"
          }
        },
        "severity": "Medium",
        "suppressionDuration": "5m",
        "name": "CYFIRMA - Medium Severity Asset based Vulnerabilities Rule Alert",
        "query": "// Medium severity - Asset based Vulnerabilities\nlet timeFrame= 5m;\nCyfirmaVulnerabilities_CL\n| extend parsed = parse_json(extensions)\n| extend extensionKeys = bag_keys(parsed)\n| mv-expand extensionKeys\n| extend extensionKeyStr = tostring(extensionKeys)\n| extend ext = parsed[extensionKeyStr]\n| extend props = ext.properties\n| extend \n    attack_complexity         = tostring(props.attack_complexity),\n    cvss_score                = toreal(props.cvss_score),\n    integrity_impact          = tostring(props.integrity_impact),\n    impact_score              = tostring(props.impact_score),\n    attack_vector             = tostring(props.attack_vector),\n    privileges_required       = tostring(props.privileges_required),\n    cvss_version              = tostring(props.cvss_version),\n    user_interaction          = tostring(props.user_interaction),\n    cvss_vector               = tostring(props.cvss_vector),\n    scope                     = tostring(props.scope),\n    confidentiality_impact    = tostring(props.confidentiality_impact),\n    exploitability_score      = toreal(props.exploitability_score),\n    products                  = tostring(props.products),\n    technologies              = tostring(props.technologies),\n    vendors                   = tostring(props.vendors),\n    confidence_score          = toint(confidence),\n    servers                   = tostring(props.servers),\n    vulnerability_type        = tostring(props.vulnerability_type),\n    vulnerability_category        = tostring(props.vulnerability_category),\n    NetworkIPs                = tostring(props.ips),\n    ProviderName              ='CYFIRMA',\n    ProductName               ='DeCYFIR/DeTCT'\n| summarize arg_max(\n                integrity_impact,\n                TimeGenerated, \n                id,\n                description,\n                confidence_score,\n                created,\n                modified,\n                attack_complexity,\n                cvss_score,\n                impact_score,\n                attack_vector,\n                privileges_required,\n                cvss_version,\n                user_interaction,\n                cvss_vector,\n                scope,\n                confidentiality_impact,\n                exploitability_score,\n                products,\n                technologies,\n                vendors,\n                ProviderName,\n                ProductName,\n                servers,\n                NetworkIPs,\n                vulnerability_type,\n                vulnerability_category\n            )\n    by name\n| where  confidence_score >= 60 and vulnerability_category != 'ATTACK_SURFACE_VULNERABILITY' and TimeGenerated between (ago(timeFrame) .. now())\n| project \n    TimeGenerated,\n    name,\n    confidence_score,\n    integrity_impact,\n    attack_complexity,\n    cvss_score,\n    impact_score,\n    attack_vector,\n    UID = id,\n    description,\n    created,\n    modified,\n    privileges_required,\n    cvss_version,\n    user_interaction,\n    cvss_vector,\n    scope,\n    confidentiality_impact,\n    exploitability_score,\n    products,\n    technologies,\n    vendors,\n    ProviderName,\n    ProductName,\n    servers,\n    NetworkIPs,\n    vulnerability_type,\n    vulnerability_category\n",
        "alertDynamicProperties": [
          {
            "value": "ProductName",
            "alertProperty": "ProductName"
          },
          {
            "value": "ProviderName",
            "alertProperty": "ProviderName"
          }
        ],
        "suppressionEnabled": false,
        "enabled": false
      }
    }
  ]
}
