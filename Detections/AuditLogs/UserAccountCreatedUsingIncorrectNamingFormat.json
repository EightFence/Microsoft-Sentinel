{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "Parameters": {
    "Workspace": {
      "type": "string"
    }
  },
  "resources": [
    {
      "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/ee55dc85-d2da-48c1-a6c0-3eaee62a8d56')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ee55dc85-d2da-48c1-a6c0-3eaee62a8d56')]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "kind": "Scheduled",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "triggerThreshold": 0,
        "queryFrequency": "1d",
        "name": "User Account Created Using Incorrect Naming Format",
        "tactics": [
          "Persistence"
        ],
        "metadata": {
          "support": {
            "tier": "Community"
          },
          "categories": {
            "domains": [
              "Security - Others"
            ]
          },
          "source": {
            "kind": "Community"
          },
          "author": {
            "name": "Pete Bryan"
          }
        },
        "severity": "Low",
        "query": "// Add the environments expected username format regex below before deploying\n  let user_regex = \"\";\n  AuditLogs\n  | where OperationName =~ \"Add user\"\n  | where Result =~ \"success\"\n  | extend userAgent = tostring(AdditionalDetails[0].value)\n  | extend addingUser = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend addingApp = tostring(parse_json(tostring(InitiatedBy.app)).displayName)\n  | extend AddedBy = iif(isnotempty(addingUser), addingUser, addingApp)\n  | extend ipAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\n  | extend AddedUser = tostring(TargetResources[0].userPrincipalName)\n  | where AddedUser matches regex user_regex\n",
        "queryPeriod": "1d",
        "triggerOperator": "gt",
        "description": "'This query looks for accounts being created where the name does not match a defined pattern.\n  Attackers may attempt to add accounts as a means of establishing persistant access to an environment, looking for anomalies in created accounts may help identify illegitimately created accounts.\n  Created accounts should be investigated to ensure they were legitimated created.\n  The user_regex field in the query needs to be populated with the expected pattern for the environment before deployment.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#accounts-not-following-naming-policies'\n",
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "FullName",
                "columnName": "AddedBy"
              }
            ]
          },
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "FullName",
                "columnName": "AddedUser"
              }
            ]
          }
        ]
      }
    }
  ]
}
